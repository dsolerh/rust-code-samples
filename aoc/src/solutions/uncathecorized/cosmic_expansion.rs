fn main() {
    println!("the distance is: {}", calculate_galaxy_sparse(DATA, 2));
    println!(
        "the distance is: {}",
        calculate_galaxy_sparse(DATA, 1000000)
    );
}

fn calculate_galaxy_sparse(data: &str, factor: usize) -> usize {
    let mut galaxies = parse_map(data, factor);

    let mut total = 0;
    while galaxies.len() != 0 {
        let mut galaxies_iter = galaxies.iter().rev();

        let galaxy = galaxies_iter.next().unwrap();
        total += galaxies_iter
            .map(|g| (g, calculate_galaxy_distance(galaxy, g)))
            // .inspect(|&(g, dist)| println!("distance from {:?} to {:?} is {}", galaxy, g, dist))
            .map(|(_, d)| d)
            .sum::<usize>();

        galaxies.pop();
    }

    total
}

fn calculate_galaxy_distance(galaxy1: &Galaxy, galaxy2: &Galaxy) -> usize {
    let (x_min, x_max) = (galaxy1.x.min(galaxy2.x), galaxy1.x.max(galaxy2.x));
    let (y_min, y_max) = (galaxy1.y.min(galaxy2.y), galaxy1.y.max(galaxy2.y));
    x_max - x_min + y_max - y_min
}

fn parse_map(data: &str, factor: usize) -> Vec<Galaxy> {
    let factor = factor - 1;
    let map = data
        .lines()
        .map(str::trim)
        .filter(|line| !line.is_empty())
        .map(|line| line.chars().collect::<Vec<_>>())
        .collect::<Vec<_>>();

    let x_max = map.len();
    let y_max = map[0].len();

    let mut x_gaps = (0..x_max).map(|_| true).collect::<Vec<_>>();
    let mut y_gaps = (0..y_max).map(|_| true).collect::<Vec<_>>();

    let mut galaxies = map
        .into_iter()
        .enumerate()
        .flat_map(|(x, line)| {
            line.into_iter().enumerate().filter_map(move |(y, ch)| {
                if ch == '#' {
                    Some(Galaxy { x, y })
                } else {
                    None
                }
            })
        })
        .collect::<Vec<_>>();

    for galaxy in &galaxies {
        x_gaps[galaxy.x] = false;
        y_gaps[galaxy.y] = false;
    }

    let mut offset = 0;
    for x in x_gaps
        .into_iter()
        .enumerate()
        .filter(|&(_, x)| x)
        .map(|(i, _)| i)
    {
        let x = x + offset;
        for galaxy in &mut galaxies {
            if x < galaxy.x {
                galaxy.x += factor;
            }
        }
        offset += factor;
    }

    offset = 0;
    for y in y_gaps
        .into_iter()
        .enumerate()
        .filter(|&(_, y)| y)
        .map(|(i, _)| i)
    {
        let y = y + offset;
        for galaxy in &mut galaxies {
            if y < galaxy.y {
                galaxy.y += factor;
            }
        }
        offset += factor;
    }

    galaxies
}

#[derive(Debug, PartialEq)]
struct Galaxy {
    x: usize,
    y: usize,
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_parse_map() {
        assert_eq!(
            parse_map(
                r"...#......
                  .......#..
                  #.........
                  ..........
                  ......#...
                  .#........
                  .........#
                  ..........
                  .......#..
                  #...#.....",
                2
            ),
            vec![
                Galaxy { x: 0, y: 4 },
                Galaxy { x: 1, y: 9 },
                Galaxy { x: 2, y: 0 },
                Galaxy { x: 5, y: 8 },
                Galaxy { x: 6, y: 1 },
                Galaxy { x: 7, y: 12 },
                Galaxy { x: 10, y: 9 },
                Galaxy { x: 11, y: 0 },
                Galaxy { x: 11, y: 5 }
            ]
        );

        assert_eq!(
            parse_map(
                r"#..#
                  ....
                  ....
                  #..#",
                2
            ),
            vec![
                Galaxy { x: 0, y: 0 },
                Galaxy { x: 0, y: 5 },
                Galaxy { x: 5, y: 0 },
                Galaxy { x: 5, y: 5 }
            ]
        );
    }

    #[test]
    fn test_calculate_galaxy_sparse() {
        assert_eq!(
            calculate_galaxy_sparse(
                r"...#......
                  .......#..
                  #.........
                  ..........
                  ......#...
                  .#........
                  .........#
                  ..........
                  .......#..
                  #...#.....",
                2
            ),
            374
        );
        assert_eq!(
            calculate_galaxy_sparse(
                r"...#......
                  .......#..
                  #.........
                  ..........
                  ......#...
                  .#........
                  .........#
                  ..........
                  .......#..
                  #...#.....",
                10
            ),
            1030
        )
    }
}

const DATA: &str = r"
........................................#........#.............#............#.........#................................................#....
....#.............................................................................................................................#.........
....................#...................................#......................................#.........................#..................
............................................................................................................................................
#..........#.....................#...............................................................................#..........................
......................................................................................................#.....................#...............
........................#..................................#.............................#..................................................
............................................#.........................#..........#............#.........................#...............#...
...#..........................#.......................#......................................................#..............................
............#...............................................................................................................................
..................................................................................................#.........................................
.........................#..................................................#...............................................................
.....................................#..............................................#..................#...................#................
...............................................#.......................#....................................#...............................
..#...............................................................#...............................................................#.........
..................#.............................................................#.........#........................#........................
.......................................#..............#......#..............................................................................
.............................#........................................................#.........#.............................#.............
...................................#....................................................................#................#...............#..
...#........................................#...............................................................................................
........................................................................#..................#................................................
...........#........................................................................#...............................#.......#...............
................#...........................................#..............................................#................................
............................................................................................................................................
......................#.......#.........#.........#................#...................................#..............................#.....
.........#....................................................................#.............................................................
..................................#..........#............#..............#..................#......#........................................
............................................................................................................................................
...................................................................................#..............................#.............#...........
#..........................#........................#...........................................#...........................................
............................................................................................................................................
.....#.......#......#.........................................#.......#.................#...............#..................#................
..............................................................................#.............................................................
.........#.............................#............................................................#.......................................
.....................................................#.......................................#.................#............................
......................#...........................................#..................................................#..................#...
..............#..........................................#.........................#........................................#...............
..........................#.....................#................................................................................#..........
..........................................................................................................#................................#
.......................................#............#...................................#...................................................
#...............#............................................#....................................................#.........................
............................#..................................................................................................#............
............#.........#.................................#.....................#.............................................................
......................................................................................................#.....................................
...#......................................#.........................#.......................................#..............#......#.....#...
..............................................................................................#.............................................
................#.............#.....................#...........................#...........................................................
............................................................................................................................................
.#......#.......................................#...........................................................................................
.............#..........................#........................#..........#....................#..........................................
............................................................................................................................................
............................................................................................................................................
..........................#........#.................................................................#.........................#............
...#.......#..................................................#......................................................................#......
................#...........................................................................................................................
..........................................#............#.......................................................#............#.............#.
............................................................................................................................................
...................#........#....................#...................................#.............................#........................
............................................................................................................................................
............................................................................................................................................
..............#.........#............................#.............#..............#....................#....................................
......................................#.....#............................................................................................#..
......#...........#...........#.........................................#........................#..........................................
.............................................................................................................#........#.....................
..............................................................#...............................................................#.............
..................................#..............#......................................#...................................................
............................................................................................................................................
.............#..............................#..................................................#............................................
...#.................#.................................................#..............................#.....................................
............................................................................................................................................
............................#..........#................#.......................#.................#..........#..............................
...............................................#..................................................................................#.........
..........#........................#........................................................................................................
......................#................................................................................#....................................
#............................................................................................#..........................#................#..
.................#..............#.......#..........#.........................#..................................#...........................
..................................................................#.....#........................#...............................#..........
.........#....................................#............................................................#..........................#.....
..#.........................................................................................................................................
............................................................................................................................................
....................#........................................#.......................#......................................................
.............................#.............................................................#.........#............#.........#.......#.......
..........................................#............#....................................................................................
............................................................................................................................................
.#...............#....................................................#..........#.............................................#............
............#......................................#.....................................#........#.................#.......................
......#.................#........#.....................................................................#...................#................
........................................#......#...............................................................#.......................#....
............................................................................................................................................
..................................................................#.....#...................................................................
.............#............................................................................................#...............................#.
............................................................................................................................................
............................#........................................................................................#.........#............
......................................................#.....................#.................#.............................................
.......................................#................................................#...................................................
............................................#...............................................................................................
.#..............#..................#..............#.............#..............................................#.....................#......
..........................................................#............#...................................................#................
........................#........................................................#..........................................................
....#..............................................................#........#.........#.....................................................
............................#...................................................................#...........................................
........................................#....................................................................#..........#...................
................................#............#..............................................#...............................................
..#......................................................#......#.................................................#...................#.....
...................#...................................................................................#....................................
.............#....................................#..........................................................................#.............#
........#.................................................................#.....#...............#...........................................
..........................................#............#..................................#...............#.................................
......................................................................................................................#.....................
.................................#...................................................#..............................................#.......
.................................................#..........#...............#..............................................#................
#.....#.................#...........................................#.............................#.............#...........................
.................#..........................................................................................................................
........................................................................#.....................#........#.................................#..
..........#...................#..........................#........................................................................#.........
....................................#...........................#.........................................................#.................
..........................#..................#.....................................#........................................................
.....#................................................#..............................................#........#.............................
.............#......................................................#................................................................#......
....................#............#..............#...............................#...............#.........................................#.
...........................................................................................#..............#......#..........................
#..........................................................#................#.........................................#.....................
.........................................#..................................................................................................
......................#..............................#..................................................................................#...
...#..........#....................#..........#...................................#...............................................#.........
.........................................................#..............#...................................................#...............
............................#....................................#.................................#...............#........................
........................................................................................................................#...................
.#...................#......................................................#............#...........................................#.....#
............#.....................................#.........#.........#.....................................................................
.............................................................................................#................#.............................
.................................#.........#............#.......................................................................#...........
...............#.......#.................................................................................#..................................
.................................................................#.......................................................#..........#.......
............................................................................................................................................
............#.....#.........#...............................#..............................#......#..........#..............................
.......................................................#............................#.......................................................
................................#..................................#...................................................#....................
............................................#......#......................#..........................................................#......
.#..............................................................................................#..................#........................";
